#{extends 'top.html' /}
#{set title:'一百券 - 我的订单' /}
#{set 'moreStyles'}
    #{asset.css src:['/u/list.css', '/u/user-center.css'] /}
<link href="@{'/public/stylesheets/my_good.css'}" rel="stylesheet" type="text/css"/>
#{/set}

#{set 'moreScripts'}
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script>
    $(window).load(function () {
        $("#search").click(function () {
            $('#orderForm').submit();
        });
        $("#status").change(function() {
            $('#orderForm').submit();
        });
   });

function doCancel(id){
if(confirm("确定取消此订单吗？")){
    $.ajax({
        type:'PUT',
        url:'/orders/'+id+"/cancel",
        success:function(data){
            window.location.reload();
        }
    });
}
}
</script>
#{/set}
<div class="wrap clearfix">
#{include "share/left.html"/}
    <div class="section">
    #{breadcrumbs/breadcrumb breadcrumbs/}
        <div class="tab_top2">
            <form class="form-horizontal" id="orderForm" action="@{UserOrders.index()}" method="GET">
                <div class="search-box">
                    <input type="hidden" name="condition.searchKey" value="2"/>
                    <label>商品名称：</label><input class="long_input" type="text" name="condition.goodsName" value="${condition.goodsName}"/>
                    <label>订单号：</label><input class="short_input" type="text" name="condition.searchItems" value="${condition.searchItems}"/>
                    <label>成交时间：</label>
                    <input class="short_input Wdate" type="text" name="condition.createdAtBegin" value="${condition.createdAtBegin?.format()}"
                        onfocus="WdatePicker({readOnly:true})"/> -
                    <input class="short_input Wdate" type="text" name="condition.createdAtEnd" value="${condition.createdAtEnd?.format()}"
                        onfocus="WdatePicker({readOnly:true})"/>
                    <button class="search-btn" id="search" style="margin-left:15px"> 搜　索</button>
                </div>
                <table class="order-tab" cellpadding="0" cellspacing="0">
                    <thead>
                    <tr class="col-name">
                        <th width="340">商品</th>
                        <th width="100">单价（元）</th>
                        <th width="38">数量</th>
                        <th width="78">实付款（元）</th>
                        <th width="85">
                            <div class="pos_abs">
                            #{select 'condition.status', id:'status', class:'dingdan_stauts_bg', value:condition.status}
                                #{option ""}交易状态#{/option}
                                #{option "UNPAID"}&{'order.UNPAID'}#{/option}
                                #{option "PAID"}&{'order.PAID'}#{/option}
                                #{option "CANCELED"}&{'order.CANCELED'}#{/option}
                            #{/select}
                            </div>
                        </th>
                        <th width="80">交易操作</th>
                    </tr>
                    </thead>
                #{paginate.list items:orderList, as:'row'}
                    <tbody>
                    <tr class="sep-row">
                        <td colspan="7"></td>
                    </tr>
                    <tr class="order-hd">
                        <td colspan="7">
                            <span class="order-no">订单号：${row.orderNumber}</span>
                            <span class="order-time">成交时间：${row.createdAt?.format("yyyy-MM-dd HH:mm:ss")}</span>
                        </td>
                    </tr>
                        #{set m=0/}
                        #{list row.orderItems, as:'rowItem'}
                        <tr class="order-bd">
                            <td align="left">
                                <a class="goods-image" href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/g/${rowItem.goods.id}" target="_blank"><img src="${rowItem.goods.imageTinyPath}"/></a>
                                <a class="goods-name" href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/g/${rowItem.goods.id}" target="_blank">${rowItem.goods.name}</a>
                            </td>
                            <td align="center">${rowItem.salePrice?.formatCurrency('CNY').raw()}</td>
                            <td align="center">${rowItem.buyNumber}</td>
                            #{if (++m == 1) }
                                <td align="center" rowspan="${row.orderItems.size()}">${row.amount}</td>
                                <td align="center" rowspan="${row.orderItems.size()}">
                                     #{if (row.status == models.order.OrderStatus.SENT)}交易成功#{/if}
                                     #{else}&{'order.'+row.status}#{/else}
                                     <div class="caozuo_std"><a style="color:#3366CC" href="@{UserOrders.details(row.orderNumber)}"
                                                               target="_blank"
                                            >订单详情</a></div>
                                </td>
                                <td align="center" rowspan="${row.orderItems.size()}">
                                    #{if (row.status == models.order.OrderStatus.UNPAID)}
                                        <div class="caozuo_std"><a class="font_red_one"
                                                                   href="@{UserOrders.pay(row.orderNumber)}">付款</a></div>
                                    #{/if}
                                    <div class="caozuo_std" id="cancel_${row.orderNumber}">
                                    #{if (row.status == models.order.OrderStatus.UNPAID)}
                                       <a class="font_red_one" href="#" onclick="doCancel(${row.orderNumber})">取消</a>
                                    #{/if}</div>
                                </td>
                            #{/if}
                        </tr>
                        #{/list}
                    </tbody>
                #{/paginate.list}
                </table>
            </form>

            <div class="pagination">
                <ul>
                #{paginate.controls items:orderList /}
                </ul>
            </div>
        </div>
    </div>
</div>
