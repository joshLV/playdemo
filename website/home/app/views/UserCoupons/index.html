#{extends 'main.html' /}
#{set title:'一百券 - 我的券' /}
#{set 'moreStyles'}
    #{asset.css src:['/y/user/userBase.css', '/y/user/userCoupons.css', '/u/popup.css'] /}
#{/set}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/common.jq.js'}" type="text/javascript" charset="UTF-8"></script>
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script>
    function applyRefund(id, money) {
        $("#coupon_id").val(id);
        $("#money").html("¥" + money);
        $.common.dialog({'id':'refund', 'title':'申请退款'});
    }

    function cancel() {
        $("#popup_close").click();

    }
    function confirmApply() {
        var coupon_id = $("#coupon_id").val();
        var url = "/coupons/refund/" + coupon_id;
        $.post(
                url,
                {"applyNote":""},
                function (data) {
                    if (data.error != 'ok') {
                        alert("申请失败: " + data.error);
                    } else {
                        $.popup.hide();
                        $("#apply_" + coupon_id).html("");
                        $("#send_" + coupon_id).html("");
                        $("#status_apply_" + coupon_id).html("已退款").removeClass().addClass('refund');
                        window.location.reload();
                    }
                }, "json");
    }

    function sendMessage(id, phone) {
        var times = $("#times_"+id).val();
        $("#downloadTimes").html(times);
        if (times == 0) {
            $("#send").hide();
            $("#gone").show();
            $.common.dialog({'id':'sendMsg', 'title':'发送短信'});
        } else {
            $("#mobile").html(phone);
            $("#id").val(id);
            $.common.dialog({'id':'sendMsg', 'title':'发送短信'});
            $("#gone").hide();
            $("#send").show();
        }
    }

    function sendMessageDialog() {
        var id = $("#id").val();
        var cnt = $("#times_"+id).val();
        $.ajax({
            url:"/coupons-message/" + id + "/send",
            type:'GET',
            error:function () {
                alert('发送失败!');
            },
            success:function (data) {
                if (data == '0') {
                    $("#send_dialog").html("<div style='text-align:center;padding-top:15px'>短信已发送成功，请查收！</div>");
                    cnt--;
                    $("#times_"+id).val(cnt);
                } else {
                    alert("发送失败!");
                }
            }
        });
    }
    $(function () {

        $("#status").change(function () {
            $("#orderForm").attr("action", "@{UserCoupons.index()}");
            $("#orderForm").attr("method", "get");
            $("#orderForm").submit();
        })
    });
</script>
#{/set}
<div id="content" class="clearfix">
    #{include "share/left.html"/}
    <div class="section">
        #{breadcrumbs/breadcrumb breadcrumbs/}
        <form class="form-horizontal" id="orderForm" action="@{UserCoupons.index()}" method="GET">
            <div class="search-box">
                <input type="hidden" name="condition.searchKey" value="2" />
                <label>商品名称：</label>
                <input class="medium-input goods-name" type="text" name="condition.goodsName" value="${condition.goodsName}" />
                <label>订单号：</label>
                <input class="short-input order-num" type="text" name="condition.searchItems" />
                <label>成交时间：</label>
                <input class="short-input Wdate" type="text" name="condition.createdAtBegin" value="${condition.createdAtBegin?.format()}" onfocus="WdatePicker({readOnly:true})"/>
                -
                <input class="short-input Wdate" type="text" name="condition.createdAtEnd" value="${condition.createdAtEnd?.format()}" onfocus="WdatePicker({readOnly:true})"/>
                <button class="search-btn" id="search"> 搜　索</button>
            </div>
            <div style="color: #ff0000">标有*的券号只限抽奖，不可用于消费</div>
            <table class="order-tab">
                <thead>
                    <tr class="col-name">
                        <th width="80">劵号</th>
                        <th>商品名称</th>
                        <th width="80">订单号</th>
                        <th width="100">截止日期</th>
                        <th width="80">消费时间</th>
                        <th width="80">
                            #{select 'condition.status', id:'status', value:condition?.status}
                                #{option ""}券状态#{/option}
                                #{option "CONSUMED"}&{'coupon.CONSUMED'}#{/option}
                                #{option "UNCONSUMED"}&{'coupon.UNCONSUMED'}#{/option}
                                #{option "REFUND"}&{'coupon.REFUND'}#{/option}
                            #{/select}
                        </th>
                        <th width="80">操作</th>
                    </tr>
                </thead>
            #{paginate.list items:couponsList, as:'coupon'}
                <tbody>
                    <tr class="sep-row"><td colspan="7"></td></tr>
                    <tr class="order-bd">
                        <td height="30" align="center">#{if row?.goods?.isLottery}<a style="color: #ff0000" href="/orders/${coupon?.order?.orderNumber}">${coupon?.getMaskedEcouponSn()}</a>#{/if}#{else}${coupon?.eCouponSn}#{/else}</td>
                        <td>
                            <a class="goods-image" href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/g/${coupon.goods.id}" target="_blank"><img src="${coupon?.goods?.imageTinyPath}"/></a>
                            <a href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/g/${coupon.goods.id}" target="_blank">${coupon?.goods?.name}</a>
                        </td>
                        <td align="center">${coupon.order.orderNumber}</td>
                        <td align="center">
                            ${coupon?.expireAt?.format()}<br>
                                #{if coupon?.getExpiredAt() >0 && coupon.status == models.order.ECouponStatus.UNCONSUMED}
                                <span class="remain-days">还有${coupon?.getExpiredAt()}天到期</span>
                                #{/if}
                        </td>
                        %{
                            now = new java.util.Date();
                            isExpired = coupon.expireAt?.before(now);
                        }%

                        <td align="center"> #{if coupon?.status != models.order.ECouponStatus.CONSUMED && isExpired }<span>已过期</span>#{/if}
                        #{else}${coupon?.consumedAt?.format('yyyy-MM-dd HH:mm:ss')} #{/else}</td>
                        <td align="center">
                            #{if coupon?.status == models.order.ECouponStatus.CONSUMED }<span class="consumed" id="status_apply_${coupon.id}">已消费</span>#{/if}
                            #{elseif coupon?.status == models.order.ECouponStatus.UNCONSUMED}<span class="unconsumed" id="status_apply_${coupon.id}">未消费</span>#{/elseif}
                            #{elseif coupon?.status == models.order.ECouponStatus.REFUND}<span class="refund" id="status_apply_${coupon.id}">已退款</span>#{/elseif}
                        *{#{/else}}*
                        </td>
                        <td align="center">
                            #{if !coupon.goods.isLottery && !isExpired && coupon.status == models.order.ECouponStatus.UNCONSUMED}
                                <a class="send-sms" href="#" id="send_${coupon.id}" onclick="sendMessage('${coupon.id}', '${coupon.orderItems.phone}')">发送短信</a>
                                <input type="hidden" id="times_${coupon.id}" value="${coupon.downloadTimes}"/>
                                <br>
                            #{/if}
                            #{if coupon.status == models.order.ECouponStatus.UNCONSUMED && !coupon?.goods?.isLottery}
                                <a class="apply-refund" href="javascript:applyRefund('${coupon.id}','${coupon.salePrice}')" id="apply_${coupon.id}">申请退款</a>
                            #{/if}
                        </td>
                    </tr>
                </tbody>
            #{/paginate.list}
            </table>
        </form>
        <div class="pagination">
            <ul>
            #{paginate.controls items:couponsList /}
            </ul>
        </div>
    </div>
</div>

<div id="sendMsg">
    <div id="send_dialog" class="popup-content" style="width:450px;height:120px">
        <div class="faq-tips" id="send">
            为了避免券损失，只能发送至购买时的手机号码，还有<span id="downloadTimes"></span>次重发机会。
            <ul id="ul">
                <li class="item">
                    <label>手机号码：</label><span id="mobile"></span>
                </li>
                <li class="item btn-box">
                    <button type="submit" onClick="sendMessageDialog()">发送短信</button>
                </li>
            </ul>
        </div>
        <div id="gone" style="text-align:center;padding-top:15px;display: none">您3次机会已经用完！</div>
        <input type="hidden" id="id"/>
    </div>
</div>

<div id="refund">
    <div id="apply_dialog" class="popup-content" style="width:350px;height:100px">
        <ul>
            <li class="item btn-box" style="padding-top:10px">
                退款金额：<span id="money"></span>
            </li>
            <li class="item btn-box" style="padding-top:25px">
                <button type="button" onClick="confirmApply()">确定</button>
                <button type="button" onClick="cancel()">取消</button>
            </li>
        </ul>
        <input type="hidden" id="coupon_id"/>
    </div>
</div>
