#{extends 'main.html' /}
#{set title:'一百券 - 我的券' /}
#{set 'moreStyles'}
    #{asset.css src:['/u/list.css','/u/popup.css'] /}
<link href="@{'/public/stylesheets/my_good.css'}" rel="stylesheet" type="text/css"/>
<link href="@{'/public/stylesheets/user-center.css'}" rel="stylesheet" type="text/css"/>
<style type="text/css">
    .left_shangpin {
        float: left;
        width: 62px;
        height: 36px;
        margin: 2px 2px;
    }

    .right_shangpin {
        width: 190px;
        margin: 2px 0px;
        line-height: 24px;
        float: left;
        font-weight: bold;
        overflow: hidden;
    }
</style>
#{/set}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/common.jq.js'}" type="text/javascript" charset="UTF-8"></script>
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script>
    function applyRefund(id, money) {
        $("#coupon_id").val(id);
        $("#money").html("¥" + money);
        $.common.dialog({'id':'refund', 'title':'申请退款'});
    }

    function cancel() {
        $("#popup_close").click();

    }
    function confirmApply() {
        var coupon_id = $("#coupon_id").val();
//        var apply_note = $("#apply_note").val();
//        if (apply_note == "") {
//            alert("请输入退款理由！");
//            return;
//        }
        var url = "/coupons/refund/" + coupon_id;
        $.post(
                url,
                {"applyNote":""},
                function (data) {
                    if (data.error != 'ok') {
                        alert("申请失败: " + data.error);
                    } else {
                        $.popup.hide();
                        $("#apply_" + coupon_id).html("");
                        $("#send_" + coupon_id).html("");

                        $("#status_apply_" + coupon_id).html("已退款");
                    }
                }, "json");
    }



    function sendMessage(id, phone) {
        var times = $("#times_"+id).val();
        $("#downloadTimes").html(times);
        if (times == 0) {
            $("#send").hide();
            $("#gone").show();
            $.common.dialog({'id':'sendMsg', 'title':'发送短信'});
        } else {
            $("#mobile").html(phone);
            $("#id").val(id);
            $.common.dialog({'id':'sendMsg', 'title':'发送短信'});
            $("#gone").hide();
            $("#send").show();
        }

    }


    function sendMessageDialog() {
        var id = $("#id").val();
        var cnt = $("#times_"+id).val();
        $.ajax({
            url:"/coupons-message/" + id + "/send",
            type:'GET',
            error:function () {
                alert('发送失败!');
            },
            success:function (data) {
                if (data == '0') {
                    $("#send_dialog").html("<div style='text-align:center;padding-top:15px'>短信已发送成功，请查收！</div>");
                    cnt--;
                    $("#times_"+id).val(cnt);
                } else {
                    alert("发送失败!");
                }
            }

        });

    }
</script>
#{/set}
<!--主体内容部分-->
<div class="wrap clearfix">
#{include "share/left.html"/}
    <div class="section">
    #{breadcrumbs/breadcrumb breadcrumbs/}
        <form class="form-horizontal" id="couponsFrm" action="@{UserCoupons.index()}" method="GET">
            <table width="774" border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td align="left">商品名称：</td>
                    <td height="35"><label> <input class="long_input" type="text" name="condition.goodsName"
                                                   value="${condition.goodsName}"/>
                    </label></td>
                    <td width="61" align="left">成交时间：</td>
                    <td width="259">
                        <input class="short_input Wdate" type="text" name="condition.createdAtBegin" id="createdAtBegin"
                               value="${condition.createdAtBegin?.format()}" onfocus="WdatePicker({readOnly:true})
                               "/> -
                        <input class="short_input Wdate" type="text" name="condition.createdAtEnd" id="createdAtEnd"
                               value="${condition.createdAtEnd?.format()}" onfocus="WdatePicker({readOnly:true})"/>
                    </td>
                    <td colspan="2" align="left" valign="middle">
                        <button class="search-btn" id="search"> 搜　索</button>
                    </td>
                </tr>
            </table>
            <table class="order-tab" cellpadding="0" cellspacing="0">
                <tr class="col-name">
                    <th width="100" align="center" height="30">劵号</th>
                    <th width="320" align="center">商品名称</th>
                    <th width="100" align="center" width="100">订单号</th>
                    <th width="100" align="center">截止日期</th>
                    <th width="100" align="center">消费时间</th>
                    <th width="18">#{select 'condition.status', id:'status', value:condition?.status}
                        #{option ""}券状态#{/option}
                        #{option "CONSUMED"}&{'coupon.CONSUMED'}#{/option}
                        #{option "UNCONSUMED"}&{'coupon.UNCONSUMED'}#{/option}
                        #{option "REFUND"}&{'coupon.REFUND'}#{/option}
                    #{/select}</th>
                    <th width="100" align="center">操作</th>
                </tr>
            #{paginate.list items:couponsList, as:'coupon'}
                <tr>
                    <td height="30" align="center">${coupon?.eCouponSn}</td>
                    <td width="320">
                        <div class="left_shangpin">
                            <a href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/goods/${coupon.goods.id}"
                               target="_blank"><img
                                    src="${coupon?.goods?.imageTinyPath}"/></a>
                        </div>
                        <div class="right_shangpin">
                            <a href="http://www.${play.Play.configuration.getProperty("application.baseDomain")}/goods/${coupon.goods.id}"
                               target="_blank">${coupon?.goods?.name}</a>
                        </div>
                    </td>
                    <td align="center">${coupon.order.orderNumber}</td>
                    <td align="center">${coupon?.expireAt?.format()}</td>
                    %{now = new java.util.Date()
                    isExpired = coupon.expireAt?.before(now) ;
                    }%
                    #{if isExpired }
                        <td width="95" align="center" style="color:#03C">
                            <span id="status_apply_${coupon.id}">已过期</span>
                        </td>
                    #{/if}
                    #{else}
                    <td align="center">${coupon?.consumedAt?.format('yyyy-MM-dd HH:mm:ss')}</td>
                    #{/else}
                    <td width="95" align="center">
                          <span id="status_apply_${coupon.id}">&{'coupon.'+coupon?.status}</span>
                    </td>

                    <td width="103" align="center">
                        #{if coupon.status == models.order.ECouponStatus.UNCONSUMED }
                            <a href="javascript:applyRefund('${coupon.id}','${coupon.salePrice}')" name="apply_refund"
                               id="apply_${coupon.id}">申请退款</a>

                        #{/if}
                        <br>
                        #{if !isExpired && coupon.status == models.order.ECouponStatus.UNCONSUMED}
                            <a href="#" id="send_${coupon.id}" onclick="sendMessage('${coupon.id}',
                                    '${coupon.orderItems.phone}')">发送短信</a>
                        <input type="hidden" id="times_${coupon.id}" value="${coupon.downloadTimes}"/>
                        #{/if}
                    </td>
                </tr>
            #{/paginate.list}
            </table>
        </form>
        <div class="pagination">
            <ul>
            #{paginate.controls items:couponsList /}
            </ul>
        </div>
    </div>
</div>

<div id="sendMsg">
    <div id="send_dialog" class="popup-content" style="width:450px;height:120px">
        <div class="faq-tips" id="send">
            为了避免券损失，只能发送至购买时的手机号码，还有<span id="downloadTimes"></span>次重发机会。
            <ul id="ul">
                <li class="item">
                    <label>手机号码：</label><span id="mobile"></span>
                </li>
                <li class="item btn-box">
                    <button type="submit" onClick="sendMessageDialog()">发送短信</button>
                </li>
            </ul>
        </div>
        <div id="gone" style="text-align:center;padding-top:15px;display: none">您3次机会已经用完！</div>

        <input type="hidden" id="id"/>
    </div>

</div>


<div id="refund">
    <div id="apply_dialog" class="popup-content" style="width:350px;height:100px">

        <ul>
            <li class="item btn-box" style="padding-top:10px">
                退款金额：<span id="money"></span>  <button type="button" onClick="confirmApply()">确定</button>
                   <button type="button" onClick="cancel()">取消</button>
            </li>

            *{<li class="item">}*
                *{<label>退款理由：</label><textarea rows="5" cols="35" id="apply_note"></textarea>}*
            *{</li>}*

        </ul>
        <input type="hidden" id="coupon_id"/>
    </div>
</div>

