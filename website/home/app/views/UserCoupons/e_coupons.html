#{extends 'main.html' /}
#{set title:'优惠啦 - 券订单' /}
#{set 'moreStyles'}
<link href="@{'/public/stylesheets/default.css'}" rel="stylesheet" type="text/css" />
<link href="@{'/public/stylesheets/my_good.css'}" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" media="screen"
      href="@{'/public/stylesheets/play-pagination.css'}">
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<style type="text/css">
    #full_bg{
        background-color: Gray;
        display:none;
        z-index:3;
        position:absolute;
        left:0px;
        top:0px;
        filter:Alpha(Opacity=30);
        /* IE */
        -moz-opacity:0.4;
        /* Moz + FF */
        opacity: 0.4;
    }

    #apply_dialog {
        position:absolute;
        width:400px;
        height:200px;
        background:white;
        display: none;
        z-index: 5;
    }

</style>
#{/set}
#{set 'moreScripts'}
<script>

    function cal_position_top(id){
        var st=document.documentElement.scrollTop;//滚动条距顶部的距离
        var ch=document.documentElement.clientHeight;//屏幕的高度
        var height=$("#"+id).height();//浮动对象的高度
        return Number(st)+(Number(ch)-Number(height))/2;
    }
    function cal_position_left(id){
        var sl=document.documentElement.scrollLeft;//滚动条距左边的距离
        var cw=document.documentElement.clientWidth;//屏幕的宽度
        var width=$("#"+id).width();//浮动对象的宽度
        return Number(sl)+(Number(cw)-Number(width))/2;
    }
    function reset_result_dialog(){
        if($("#full_bg").css("display") == "block"){
            var body_height=document.documentElement.clientHeight;//屏幕的高度
            var body_width=document.documentElement.clientWidth;//屏幕的宽度
//        var body_height = $("body").height();
//        var body_width  = $("body").width();
            $("#full_bg").css({
                width:body_width,
                height:body_height});
            $("#apply_dialog").css({
                top:cal_position_top("apply_dialog"),
                left:cal_position_left("apply_dialog"),
                display:"block"});

        }
    }
    function close_result_dialog(){
        $("#full_bg").css({display:"none"});
        $("#apply_dialog").css({display:"none"});
    }


$(window).load(function () {

    $(window).scroll(function(){reset_result_dialog()});
    $(window).resize(function(){reset_result_dialog()});

 $("#search").click(function () {
     $('#couponsFrm').submit();
 });
 $("a[name='apply_refund']").each(function(){
     $(this).click(function(){
         $("#apply_row").val($(this).attr('id'));
         $("#full_bg").css({"display":"block"});
         reset_result_dialog();
         return false;
     });
 });

    $("#confirm_apply").click(function(){
        close_result_dialog();
        $.post(
                $("#"+$("#apply_row").val()).attr("href"),
                {"applyNote":$("#apply_note").val()},
                function(data){
                    if(data.error != 'ok'){
                        alert("申请失败: " + data.error);
                    }else{
                        $("#"+$("#apply_row").val()).empty().append("");
                        $("#status_"+$("#apply_row").val()).empty().append("已退款");
                    }
                }
        );
        return false;
    });

});
</script>
#{/set}

<body>
<div id="full_bg"></div>
<div id="apply_dialog">
    <div style="text-align:center;">
        <a href="#" onclick="close_result_dialog();">关闭</a><br/><br/>
        <label for="refund">退款金额</label><input type="text" id="refund" /><br/><br/>
        <label for="apply_note">申请理由</label><textarea rows="5" id="apply_note"></textarea> <br/>
        <a  href="#" id="confirm_apply">确定</a>
    </div>
    <input value="" type="hidden" id="apply_row"/>
</div>


 <div id="wrap_main">
   <!--    最顶部导航-->
   <div id="wrap_top">#{include "share/topNavigator.html"/}</div>
   <div id="wrap_top_header">
   <div id="wrap_top_header_left">
    <img src="@{'/public/images/logo.jpg'}" />
   </div>
   <div id="wrap_top_middle">券生活-惠生活</div>

  </div>
  <div style="clear: both"></div>
  <div class="nav_hengfu">
   <ul class="nav_bg_ul">
    <li class="nav_bg_li"><a class="current_nav_bg_a" href="#">我的优惠啦</a></li>
    <li class="nav_bg_li nodisplay"><a class="nav_bg_a" href="#">我的优惠啦</a></li>
    <li class="nav_bg_li nodisplay"><a class="nav_bg_a" href="#">我的优惠啦</a></li>
   </ul>
  </div>
 </div>
 <!--主体内容部分-->
 <div id="wrap_content">
 #{breadcrumbs/breadcrumb breadcrumbs/}
 #{include "share/left.html"/}
  <div id="right_content_box">
   <div class="tab_top">我的商品订单</div>
   <div class="tab_top2">
    <form class="form-horizontal" id="couponsFrm" action="@{UserCoupons.coupons()}" method="GET">
    <table width="774" border="0" cellpadding="0" cellspacing="0">
     <tr>
      <td width="12">&nbsp;</td>
      <td width="61" align="right">成交时间：</td>
      <td width="259" height="35">
      <input class="short_input Wdate" type="text" name="condition.createdAtBegin" value="${createdAtBegin?.format()}" onfocus="WdatePicker({readOnly:true})" /> -
     <input class="short_input Wdate" type="text" name="condition.createdAtEnd" value="${createdAtEnd?.format()}" onfocus="WdatePicker({readOnly:true})" />
     </td>
      <td width="77">订单状态：</td>
      <td width="353">
       <div class="pos_abs">
        #{select 'condition.status', id:'status', class:'dingdan_stauts_bg', value:status}
               #{option ""}不限#{/option}
               #{option "DEALING"}&{'coupon.DEALING'}#{/option}
               #{option "CONSUMED"}&{'coupon.CONSUMED'}#{/option}
               #{option "UNCONSUMED"}&{'coupon.UNCONSUMED'}#{/option}
               #{option "REFUND"}&{'coupon.REFUND'}#{/option}
               #{option "EXPIRED"}&{'coupon.EXPIRED'}#{/option}
         #{/select}
       </div>
      </td>
     </tr>
     <tr>
      <td>&nbsp;</td>
      <td align="right">商品名称：</td>
      <td height="35"><label> <input class="long_input" type="text" name="condition.goodsName" value="${goodsName}"/>
      </label></td>
      <td colspan="2" align="left" valign="middle"><a class="seach_bg" href="#" id="search">搜素</a></td>
     </tr>
    </table>
    </form>
    <table width="798" border="1" cellpadding="0" cellspacing="0" bordercolor="#EEEEEE" frame="void">
     <tr bgcolor="#FBE8E4">
      <td  width="100" align="center">劵号</td>
      <td align="center">商品名称</td>
      <td width="100" height="28" align="center" bgcolor="#FBE8E4">订单号</td>
      <td height="30" align="center">价格</td>
      <td height="30" align="center">成交时间</td>
      <td align="center">消费时间</td>
      <td align="center">状态</td>
      <td align="center">操作</td>
     </tr>
     #{paginate.list items:couponsList, as:'coupon'}
      <tr>
      <td width="118" height="30" align="center">${coupon.eCouponSn}</td>
      <td width="177" align="center">${coupon.goods.name}</td>
      <td width="100" height="31" align="center">${coupon.order.orderNumber}</td>
      <td width="177" align="center" id="price_${coupon.id}">${coupon.salePrice?.formatCurrency('CNY').raw()}</td>
      <td width="106" align="center">${coupon.createdAt?.format('yyyy-MM-dd HH:mm:ss')}</td>
      <td width="123" align="center">${coupon.consumedAt?.format('yyyy-MM-dd HH:mm:ss')}</td>
      <td width="95" align="center"><span id="status_apply_${coupon.id}">&{'coupon.'+coupon.status}</span></td>
      <td width="103" align="center">
      #{if (coupon.status == models.order.ECouponStatus.UNCONSUMED
      || coupon.status == models.order.ECouponStatus.EXPIRED)}
      <a href="/coupons/refund/${coupon.id}" name="apply_refund" id="apply_${coupon.id}">申请退款</a>
      #{/if}
      </td>
     </tr>
     #{/paginate.list}
    </table>
     <div class="pagination">
     <ul>
    #{paginate.controls items:couponsList /}
    </ul>
  </div>
   </div>
  </div>
 </div>
</body>
