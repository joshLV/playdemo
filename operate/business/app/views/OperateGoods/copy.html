#{extends 'layout_operate/layout.html' /}
#{set title:'复制商品' /}
#{get 'moreScripts'}
<script src="@{'/public/javascripts/kindeditor-min.js'}" type="text/javascript" charset="UTF-8"></script>
<script src="@{'/public/javascripts/lang/zh_CN.js'}" type="text/javascript" charset="UTF-8"></script>
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
#{/get}
#{include '/share/nav.html' /}
<div class="body">
#{form @OperateGoods.create() , id:'form',enctype:'multipart/form-data',class:"form-horizontal" }
<legend>${title}</legend>
    #{if noShopTip != null}
    <h1>${noShopTip.raw()}</h1>
    #{/if}
    #{else}
        #{set 'moreScripts'}
            #{get 'moreScripts'/}
        <script src="@{'/public/javascripts/goods-form.js'}" type="text/javascript" charset="UTF-8"></script>
        #{/set}
        #{layout_operate.radioField name:'goods.materialType',
        value1:models.sales.MaterialType.ELECTRONIC.toString(),
        value2:models.sales.MaterialType.REAL.toString(),
        value:goods?.materialType?.toString(), required:true/}
        #{layout_operate.checkboxField name:'goods.publishedPlatforms', items:models.sales.GoodsPublishedPlatformType
        .values(), value:goods?.publishedPlatforms/}

            #{layout_operate.selectField name:'goods.supplierId', class:'span2', value:goods?.supplierId,
            error:'goods.supplierId'}
                #{list items:supplierList, as:'supplier' }
                    #{option supplier.id}${supplier.fullName}#{/option}
                #{/list}
            #{/layout_operate.selectField}
    <div class="control-group">
        <label class="control-label"><span style="color: red; ">*</span>商品分类</label>

        <div class="controls">
            #{layout_operate.selectList name:'goods.topCategoryId', value:goods?.topCategoryId, list:categoryList/}
            #{layout_operate.selectList name:'goods.categories.id', value:categoryId, list:subCategoryList/}
            <span class="error">#{error 'goods.category'/}</span>
        </div>
    </div>
    <div id="brand">#{include '/OperateBrands/goodsBrands.html'/}</div>
        #{layout_operate.textField name:'goods.no', value:goods?.no/}
        #{layout_operate.nameField name:'goods.name', value:goods?.name, required:true, length:30/}
        #{layout_operate.nameField name:'goods.title', value:goods?.title,note:'(包含商家名称和面值)', required:true, length:30/}
        #{layout_operate.dateScopeField name:'goods.effective', begin:'goods.effectiveAt',end:'goods.expireAt',required:true/}
        #{layout_operate.textField name:'goods.faceValue', value:"0", note:'元', required:true/}
        #{layout_operate.textField name:'goods.originalPrice', value:"0",note:'元', required:true/}
        #{layout_operate.textField name:'goods.salePrice', value:"0", note:'元', required:true/}
        #{set i:0/}
        #{list items:models.resale.ResalerLevel.values(), as: 'level'}
        <div class="control-group">
            <label for='levelPrices_${level}' class="control-label">
                <span style="color: red; ">*</span>&{'goods.levelPrice.'+models.resale.ResalerLevel.values()[i]}</label>

            <div class="controls">
                <input type="text" id='levelPrices_${level}' name="levelPrices" class="input-xlarge"
                       value="0"
                       onfocus="showPrice(this);limitMoneyFormat(this,this.value)"
                       onkeyup="showPrice(this);limitMoneyFormat(this,this.value)"
                       onkeydown="showPrice(this);limitMoneyFormat(this,this.value)"
                       onchange="showPrice(this);limitMoneyFormat(this,this.value)"/>元 <span
                    style="color: blue; ">加价后为</span><span style="color: red; "
                                                           id="realPrice_levelPrices_${level}">0</span><span
                    style="color: blue; ">元</span>
                #{field 'goods.levelPrice.'+level}
                    <span class="error">#{error field?.name/}</span>
                #{/field}
            </div>
        </div>
            #{set i++/}
        #{/list}

        #{layout_operate.textField name:'goods.baseSale', value:"0", note:'件', required:true/}

        #{layout_operate.textField name:'goods.limitNumber', value:'0', note:'个'/}

        #{layout_operate.timeScopeField name:'goods.useTime', begin:'goods.useBeginTime',end:'goods.useEndTime'/}
    <div class="control-group">
        <label class="control-label">抽奖商品
        </label>
        <div class="controls">
            <input type="checkbox" name="goods.isLottery" id="isLottery" class="input-medium"/>
        </div>
    </div>
        #{layout_operate.fileField name:'imagePath',note:'图片尺寸：(340*260像素)', required:true/}
        #{layout_operate.htmlField name:'goods.prompt', value:goods?.prompt, uploadImgUrl:'/goods/images'/}
        #{layout_operate.htmlField name:'goods.details', value:goods?.details, uploadImgUrl:'/goods/images', required:true/}
        #{layout_operate.radioField name:'goods.isAllShop', value:isAllShop?:false, required:true/}

        #{layout_operate.textField name:'goods.keywords', value:goods?.keywords /}

    <div class="control-group">
        <label class="control-label"></label>

        <div class="controls" id="shop" style="display:none">
            <table id="tableShop" class="table table-striped table-bordered table-condensed">
                #{include '/OperateShops/showGoodsShops.html'/}
            </table>
        </div>
    </div>
    <div class="form-actions">
        <input class="btn btn-primary" id="save" type="submit" value="保存"/>
        <input class="btn btn-primary" id="onsale" type="submit" value="保存并上架"/>
        *{<input class="btn btn-primary" id="preview" type="submit" value="预览"/>}*
        #{if "edit".equals(action)}
            #{vx.cancelButton url:'/goods', class:'btn btn-primary'/}
        #{/if}
        <input type="hidden" id="status" name="goods.status" value="${goods?.getStatus()?:'OFFSALE'}"/>
    </div>
    <script type="text/javascript">
        $("input[name='goods.isAllShop']:checked").val() == 'false' ? $("#shop").show() : $("#shop").hide();
        function showPrice(nameField) {
            var originalPrice = $("#goods_originalPrice").val() == null ? 0 : $("#goods_originalPrice").val();
            var price = parseFloat($(nameField).val()) + parseFloat(originalPrice);
            price = (price == null || price.toString() == "NaN") ? 0 : price;
            $("#realPrice_" + nameField.id).html(price.toFixed(2));
        }

        function showAddedPrice() {
            var originalPrice = $("#goods_originalPrice").val() == null ? 0 : $("#goods_originalPrice").val();
            #{list items:models.resale.ResalerLevel.values(), as: 'level'}
                var price = parseFloat($('#levelPrices_${level}').val()) + parseFloat(originalPrice);
                price = (price == null || price.toString() == "NaN") ? 0 : price;
                $("#realPrice_levelPrices_${level}").html(price.toFixed(2));
            #{/list}
        }

        showAddedPrice();

        $(function () {

            $("#goods_faceValue").keyup(function () {
                limitMoneyFormat(this, $("#goods_faceValue").val());
            })

            $("#goods_salePrice").keyup(function () {
                limitMoneyFormat(this, $("#goods_salePrice").val());
            })

            $("#goods_originalPrice").keyup(function () {
                limitMoneyFormat(this, $("#goods_originalPrice").val());
                showAddedPrice();
            })
            $("#goods_originalPrice").keydown(function () {
                limitMoneyFormat(this, $("#goods_originalPrice").val());
                showAddedPrice();
            })
            $("#goods_originalPrice").change(function () {
                showAddedPrice();
            })
            $("#goods_originalPrice").focus(function () {
                limitMoneyFormat(this, $("#goods_originalPrice").val());
                showAddedPrice();
            })
            $("#goods_isAllShop_2").click(function () {
                $("#shop").show();//显示门店列表
                #{if "edit".equals(action)}
                    $("#selectAll").click();
                #{/if}
            });
        });
        function limitMoneyFormat(obj, value) {
            if (value != null && value != '') {
                var decimalIndex = value.indexOf('.');
                if (decimalIndex == '-1') {
                    return false;
                } else {
                    var decimalPart = value.substring(decimalIndex + 1, value.length);
                    if (decimalPart.length > 2) {

                        $(obj).val(value.substring(0, decimalIndex + 3));
                        return false;
                    }
                }
            }
            return true;
        }
    </script>
    #{/else}
#{/form}
</div>

