#{extends 'layout_operate/layout.html' /}
#{set title:'商品一览' /}
#{include '/share/nav.html' /}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/goods.js'}" type="text/javascript" charset="UTF-8"></script>
#{/set}
#{set 'moreStyles'}
<style type="text/css">
    .table-striped tbody .tr-offsale {
        color: #A0A0A0;
    }

    .table-striped tbody tr.transparent td td {
        border-left: 0px;
        background: transparent;
    }

    .expired {
        color: #ffbe28;
        font-weight: bold;
    }

    .zeroBaseSale {
        color: #942e8f;
        font-weight: bold;
    }

    .rank {
        background-image: url(http://img.uhcdn.com/images/r/rank.png);
        background-position: right 6px;
        background-repeat: no-repeat;
    }

    .rank-asc {
        background-position: right -15px;
    }

    .rank-desc {
        background-position: right -36px;
    }

</style>
#{/set}
<div class="body">
<legend>${title}</legend>
<form class="form-horizontal" name="frmlist" id="frmlist" action="@{OperateGoods.index()}" method="GET">
    <table width="100%">
        <tr>
            <td width="30%">商&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;户：
            #{select 'condition.supplierId', id:supplierId, class:'select', value:condition?.supplierId}
                #{option "0"}不限#{/option}
                #{list items:supplierList, as:'supplier'}
                    #{option supplier?.id}${supplier?.otherName==null?supplier?.fullName:supplier?.otherName}#{/option}
                #{/list}
            #{/select}</td>

            <td width="30%">商品名称：<input type="text" name="condition.name" class="input-medium"
                                        value="${condition?.name}"/></td>
            <td width="30%">商品编号：<input type="text" name="condition.no" class="input-medium"
                                        value="${condition?.no}"/></td>
            <td></td>
        </tr>
        <tr>
            <td width="30%">品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;牌：
            #{select 'condition.brandId', id:'brandId', class:'select', value:condition?.brandId}
                #{option "0"}不限#{/option}
                #{list items:brandList, as:'brand'}
                    #{option brand?.id}${brand?.name}#{/option}
                #{/list}
            #{/select}</td>
            <td width="30%">状&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;态：
            #{select 'condition.status', id:'condition_status', class:'input-small', value:condition?.status}
                #{option ""}不限#{/option}
                #{option "ONSALE"}&{'goods.ONSALE'}#{/option}
                #{option "OFFSALE"}&{'goods.OFFSALE'}#{/option}
                #{option "APPLY"}&{'goods.APPLY'}#{/option}
                #{option "REJECT"}&{'goods.REJECT'}#{/option}
            #{/select}
                &nbsp; &nbsp;
                设置精选：<input type="checkbox" name="condition.priority" id="priority" class="input-medium"
                            value="${condition?.priority}" ${condition?.priority == 1 ?'checked':''}/>
                &nbsp; &nbsp;抽奖商品：<input type="checkbox" name="condition.isLottery" id="isLottery" class="input-medium"
                                         value="${condition?.isLottery}" ${condition?.isLottery ?'checked':''}/>
            </td>
        </tr>
        <tr>
            <td width="30%">现&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：<input type="text" name="condition.salePriceBegin"
                                                                          class="input-medium"
                                                                          value="${condition?.salePriceBegin}"/>
                至 <input type="text" name="condition.salePriceEnd" class="input-medium"
                         value="${condition?.salePriceEnd}"/>
            </td>
            <td>销&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量：<input type="text" name="condition.saleCountBegin"
                                                              class="input-medium"
                                                              value="#{if condition?.saleCountBegin >=0}${condition?.saleCountBegin}#{/if}"/>
                至 <input type="text" name="condition.saleCountEnd" class="input-medium"
                         value="#{if condition?.saleCountEnd >=0}${condition?.saleCountEnd}#{/if}"/>
            </td>
            <td>
                <button class="btn btn-primary" id="searchbtn" type="submit">/搜索</button>
            </td>
            <input type="hidden" id="J_rank" name="desc"/>
        </tr>
    </table>
</form>
<form class="form-horizontal" name="deletefrm" id="deletefrm">
<div style="margin-bottom: 12px">
    <button class="btn btn-primary" id="onsales" type="button">同意上架</button>
*{<button class="btn btn-primary" id="offsales" type="button">批量下架</button>}*
    <button class="btn btn-primary" id="deletebtn" type="button">删除</button>
</div>


#{vx.tab name:'goods',enumItems: [models.sales.GoodsStatus.ONSALE,models.sales.GoodsStatus.OFFSALE,
models.sales.GoodsStatus.APPLY,models.sales.GoodsStatus.REJECT],
select:'condition_status',value:condition?.status/}
<table class="table table-striped table-bordered table-condensed">
    <thead>
    <tr>
        <th width="50px"><input type="checkbox" id="selectall" name="selectall">全选</th>

    #{if desc.equals("10000000000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank" data-rank="20000000000">&{'goods.supplierId'}</a>
        </th>#{/if}
    #{elseif desc.equals("20000000000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank" data-rank="10000000000">&{'goods.supplierId'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="20000000000">&{'goods.supplierId'}</a>
        </th>#{/else}

    #{if desc.equals("01000000000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank" data-rank="02000000000">&{'goods.no'}</a>
        </th>#{/if}
    #{elseif desc.equals("02000000000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank" data-rank="01000000000">&{'goods.no'}</a>
        </th>#{/elseif}
    #{else}
        <th width="30px" class="rank"><a class="fn-rank" data-rank="02000000000">&{'goods.no'}</a></th>#{/else}

    #{if desc.equals("00100000000") }
        <th class="rank rank-asc"><a class="fn-rank" data-rank="00200000000">&{'goods.name'}</a></th>#{/if}
    #{elseif desc.equals("00200000000")}
        <th class="rank rank-desc"><a class="fn-rank" data-rank="00100000000">&{'goods.name'}</a></th>#{/elseif}
    #{else}
        <th class="rank"><a class="fn-rank" data-rank="00200000000">&{'goods.name'}</a></th>#{/else}

    #{if desc.equals("00010000000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank" data-rank="00020000000">&{'goods.faceValue'}</a>
        </th>#{/if}
    #{elseif desc.equals("00020000000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank" data-rank="00010000000">&{'goods.faceValue'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="00020000000">&{'goods.faceValue'}</a>
        </th>#{/else}

    #{if desc.equals("00001000000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank"
                                                  data-rank="00002000000">&{'goods.originalPrice'}</a></th>#{/if}
    #{elseif desc.equals("00002000000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank"
                                                   data-rank="00001000000">&{'goods.originalPrice'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="00002000000">&{'goods.originalPrice'}</a>
        </th>#{/else}

    #{if desc.equals("00000100000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank" data-rank="00000200000">&{'goods.salePrice'}</a>
        </th>#{/if}
    #{elseif desc.equals("00000200000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank" data-rank="00000100000">&{'goods.salePrice'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="00000200000">&{'goods.salePrice'}</a>
        </th>#{/else}

    #{if desc.equals("00000010000") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank" data-rank="00000020000">&{'goods.baseSale'}</a>
        </th>#{/if}
    #{elseif desc.equals("00000020000")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank" data-rank="00000010000">&{'goods.baseSale'}</a>
        </th>#{/elseif}
    #{else}
        <th width="30px" class="rank"><a class="fn-rank" data-rank="00000020000">&{'goods.baseSale'}</a>
        </th>#{/else}

    #{if desc.equals("00000001000") }
        <th width="60px" class="rank rank-asc"><a class="fn-rank" data-rank="00000002000">&{'goods.saleCount'}</a>
        </th>#{/if}
    #{elseif desc.equals("00000002000")}
        <th width="60px" class="rank rank-desc"><a class="fn-rank" data-rank="00000001000">&{'goods.saleCount'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="00000002000">&{'goods.saleCount'}</a>
        </th>#{/else}

    #{if desc.equals("00000000100") }
        <th width="80px" class="rank rank-asc"><a class="fn-rank"
                                                  data-rank="00000000200">&{'goods.firstOnSaleAt'}</a></th>#{/if}
    #{elseif desc.equals("00000000200")}
        <th width="80px" class="rank rank-desc"><a class="fn-rank"
                                                   data-rank="00000000100">&{'goods.firstOnSaleAt'}</a>
        </th>#{/elseif}
    #{else}
        <th width="80px" class="rank"><a class="fn-rank" data-rank="00000000200">&{'goods.firstOnSaleAt'}</a>
        </th>#{/else}

    #{if desc.equals("00000000010") }
        <th width="80px" class="rank rank-asc"><a class="fn-rank" data-rank="00000000020">&{'goods.updatedAt'}</a>
        </th>#{/if}
    #{elseif desc.equals("00000000020")}
        <th width="80px" class="rank rank-desc"><a class="fn-rank" data-rank="00000000010">&{'goods.updatedAt'}</a>
        </th>#{/elseif}
    #{else}
        <th width="80px" class="rank"><a class="fn-rank" data-rank="00000000020">&{'goods.updatedAt'}</a>
        </th>#{/else}

    #{if desc.equals("00000000001") }
        <th width="50px" class="rank rank-asc"><a class="fn-rank"
                                                  data-rank="00000000002">&{'goods.materialType'}</a></th>#{/if}
    #{elseif desc.equals("00000000002")}
        <th width="50px" class="rank rank-desc"><a class="fn-rank"
                                                   data-rank="00000000001">&{'goods.materialType'}</a>
        </th>#{/elseif}
    #{else}
        <th width="50px" class="rank"><a class="fn-rank" data-rank="00000000002">&{'goods.materialType'}</a>
        </th>#{/else}

        <th width="50px">&{'goods.status'}</th>
        <th width="50px">操 作</th>
    </tr>
    </thead>

    <tbody>

    #{paginate.list items:goodsPage, as:'goods'}
    <tr class="#{if goods.isExpired() || goods.baseSale?.intValue() == 0}tr-offsale#{/if} transparent">
        <td style="text-align:center"><input type="checkbox" id="checkoption" value="${goods.id}" name="id"/></td>
        <td>${goods?.getSupplier()?.fullName}</td>
        <td>${goods?.no}</td>
        <td>
            <table>
                <tbody>
                <tr>
                    <td>
                        <a href="http://${play.Play.configuration.getProperty("www.url")}/g/${goods.id}?preview=true"><img
                                src="${goods?.imageTinyPath}"/></a></td>
                    <td>
                        <a href="http://${play.Play.configuration.getProperty("www.url")}/g/${goods.id}?preview=true">${goods?.name}
                        </a>
                        #{if goods.priority != null && goods.priority >0}
                            &nbsp;<span style="color: #ff0000;">&{'goods.priority'}:${goods.priority}</span>#{/if}
                        #{if goods.keywords != null}
                            <br/>SEO关键字: ${goods.keywords}
                        #{/if}
                    </td>
                </tr>
                </tbody>
            </table>
        </td>
        <td class="amount">${goods?.faceValue?.formatCurrency('CNY')}</td>
        <td class="amount">${goods?.originalPrice?.formatCurrency('CNY')}</td>
        <td class="amount">${goods?.salePrice?.formatCurrency('CNY')}</td>
        <td class="amount">${goods?.baseSale}</td>
        <td class="amount">${goods?.saleCount}</td>
        <td>${goods?.firstOnSaleAt?.format('yyyy-MM-dd HH:mm:ss')}</td>
        <td>${goods?.updatedAt?.format('yyyy-MM-dd HH:mm:ss')}</td>
        <td>&{'goods.'+goods?.materialType}</td>
        <td> #{if goods.isExpired()}<span class="expired">已过期</span><br/>#{/if}
            #{if goods.baseSale?.intValue() == 0}<span class="zeroBaseSale">零库存</span><br/>#{/if}
        &{'goods.'+goods?.getStatus()}
            #{if models.sales.GoodsStatus.APPLY.equals(goods.status)}
                <br/>#{vx.operateLink text:"同意上架", url:"/goods/"+goods?.id+"/onSale",method:"PUT"/}
                <br/>#{vx.operateLink text:"拒绝上架", url:"/goods/"+goods?.id+"/reject",method:"PUT"/}#{/if}
            #{if models.sales.GoodsStatus.ONSALE.equals(goods.status)}
                <br/>#{vx.operateLink text:"强制下架", url:"/goods/"+goods?.id+"/offSale",method:"PUT"/}#{/if}
            #{if models.sales.GoodsStatus.REJECT.equals(goods.status)}
                <br/>#{vx.operateLink text:"同意上架", url:"/goods/"+goods?.id+"/onSale",method:"PUT"/}#{/if}
            #{if models.sales.GoodsStatus.OFFSALE.equals(goods.status)}
                <br/>#{vx.operateLink text:"同意上架", url:"/goods/"+goods?.id+"/onSale",method:"PUT"/}#{/if}
        </td>
        <td>

            <a href="@{OperateGoods.show(goods.id)}">查看</a>

            #{if !models.sales.GoodsStatus.APPLY.equals(goods.status)}
                /<a href="@{OperateGoods.edit(goods.id)}">修改</a>
            #{/if}
            #{if !models.sales.GoodsStatus.ONSALE.equals(goods.status) && !models.sales.GoodsStatus.APPLY
            .equals(goods.status)}
                / #{vx.deleteLink action:"goods", id:goods.id, name:goods.name/}
            #{/if}
            #{if models.sales.GoodsStatus.ONSALE.equals(goods.status) }
                /<a href="#" id="linkSend_${goods.id}"
                    onclick="prepareSend('${goods.id}','${goods.priority}','${goods.keywords}')
                            ">网站选项</a>

            #{/if}/<a href="@{OperateGoods.copy(goods.id)}">复制</a>
            /

            <a href="@{OperateGoods.showHistory(goods.id)}" target="_blank">查看历史记录</a>
    </tr>
    #{/paginate.list}
    </tbody>
</table>
</form>
<div class="pagination" align="center">
    <ul>
    #{paginate.controls items:goodsPage /}
    </ul>
</div>
</div>

<div class="modal" id="sendModal" style="display: none;">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>

        <h3>设置网站发布选项</h3>
    </div>
    <div class="modal-body">
    #{form @OperateOrders.index(), id:"setForm", name:"setForm",class:"form-horizontal",method:"PUT"}
    #{layout_operate.textField name:'goods.priority',value:'',required:true/}
    #{layout_operate.textField name:'goods.keywords', value:'' /}
    #{/form}
    </div>
    <div class="modal-footer">
        <a href="#" id="sure" class="btn btn-primary">确定</a>
        <a href="#" class="btn" data-dismiss="modal">取消</a>
    </div>
</div>

<script type="text/javascript">
    function prepareSend(id, priority, keywords) {
        $("#setForm").attr("action", "/goods/" + id + "/priority?x-http-method-override=PUT");
        $('#sendModal').modal('show');
        $("#goods_priority").val(priority);
        $("#goods_keywords").val(keywords);
    }

    $(function () {
        $("#sure").click(function () {
            var result = true;
            if ($("#goods_priority").val().trim() == "") {
                $("#note_goods_priority").html("<span style='display: block;color: #ff0000;'>请输入精选指数!</span>");
                $("#note_goods_priority").focus();
                result = false;
            }

            if (isNaN($("#goods_priority").val().trim())) {
                $("#note_goods_priority").html("<span style='display: block;color: #ff0000;'>精选指数无效!</span>");
                $("#note_goods_priority").focus();
                result = false;
            }
            if (result) {
                $("#setForm").submit();
            }
        });

        $("#priority").click(function () {
            if (this.checked) {
                this.value = "1";
            } else {
                this.value = "0";
            }
            $("#frmlist").submit();
        });

        $("#isLottery").click(function () {
            if (this.checked) {
                this.value = true;
            } else {
                this.value = false;
            }
            $("#frmlist").submit();
        });

        $('.fn-rank').click(function (ev) {
            ev.preventDefault();
            var rankStr = $(this).attr('data-rank');
            $('#J_rank').val(rankStr);
            $('#frmlist').submit();
        });
    });
</script>
