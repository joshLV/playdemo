#{extends 'layout_operate/layout.html' /}
#{include 'share/nav.html' /}
#{set title:'商品订单' /}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
    function prepareSend(id) {
        $("#sendForm").attr("action", "/orders/" + id + "/send?x-http-method-override=PUT");
        $('#sendModal').modal('show');
    }

    $(function () {
        #{if !play.Play.runingInTestMode()}
            $("#send").click(function () {
                var result = true;
                if ($("#order_deliveryNo").val().trim() == "") {
//                $("#note_order_deliveryNo").addClass("error");
                    $("#note_order_deliveryNo").html("请输入单号!");
                    $("#order_deliveryNo").focus();
                    result = false;
                }
                else {
//                $("#note_order_deliveryCompany").removeClass("error");
                    $("#note_order_deliveryCompany").html("");
                }
                if ($("#order_deliveryCompany").val().trim() == "") {
//                $("#note_order_deliveryCompany").addClass("error");
                    $("#note_order_deliveryCompany").html("请输入公司!");
                    $("#order_deliveryCompany").val("");
                    $("#order_deliveryCompany").focus();
                    result = false;
                } else {
                    $("#note_order_deliveryCompany").removeClass("error");
                    $("#note_order_deliveryCompany").html("");
                }
                if (result) {
                    $("#sendForm").submit();
                }
            });
        #{/if}
        #{else}
            $("#send").click(function () {
                $("#sendForm").submit();
            });
        #{/else}

        $("#isLottery").click(function () {
            if (this.checked) {
                this.value = true;
            } else {
                this.value = false;
            }
            $("#frmlist").submit();
        });
           $("#search").click(function () {
            $("#frmlist").attr("action", "@{OperateOrders.index()}");
            $("#frmlist").attr("method", "get");
            $("#frmlist").submit();
        });
    });
   function orderExcel() {
        $("#frmlist").attr("action", "@{OperateOrders.orderExcelOut()}");
        $("#frmlist").attr("method","get");
        $("#frmlist").submit();
    };


    function changeList(status) {
        $("#condition_status").val(status);
        $("#frmlist").attr("method", "get");
        $("#frmlist").attr("action", "@{OperateOrders.index()}");
        $("#frmlist").submit();
    }

</script>
#{/set}
#{set 'moreStyles'}
<style type="text/css">
    .table td {
        vertical-align: middle;
    }
</style>
#{/set}
<div class="body">
    <legend>商品订单</legend>
    <form class="form-horizontal" name="frmlist" id="frmlist" method="GET">
        <table width="80%">
            <tr>
                <td>成交时间：<input type="text" id="createdAtBegin" name="condition.createdAtBegin"
                                value="${condition.createdAtBegin?.format()}" onfocus="WdatePicker({readOnly:true})"
                                class="input-medium Wdate"/>至 <input type="text" id="createdAtEnd"
                                                                     name="condition.createdAtEnd"
                                                                     value="${condition.createdAtEnd?.format()}"
                                                                     onfocus="WdatePicker({readOnly:true})"
                                                                     class="input-medium Wdate"/></td>
                <td>物流方式：
                #{select 'condition.deliveryType', class:'input-small', value:condition.deliveryType}
                    #{option ""}不限#{/option}
                    #{option models.order.DeliveryType.SMS}无物流#{/option}
                    #{option models.order.DeliveryType.LOGISTICS}有物流#{/option}
                #{/select}
                </td>
            </tr>
            <tr>
                <td>退款时间：<input type="text" name="condition.refundAtBegin" value="${condition.refundAtBegin?.format()}"
                                onfocus="WdatePicker({readOnly:true})"
                                class="input-medium Wdate"/>至 <input type="text" name="condition.refundAtEnd"
                                                                     value="${condition.refundAtEnd?.format()}"
                                                                     onfocus="WdatePicker({readOnly:true})"
                                                                     class="input-medium Wdate"/></td>
                <td>支付方式：#{select 'condition.payMethod', class:'input-small', value:condition.payMethod}
                    #{option ""}不限#{/option}
                    #{option "alipay"}支付宝#{/option}
                    #{option "tenpay"}财付通#{/option}
                    #{option "99bill"}快钱#{/option}
                #{/select}
                </td>
            </tr>
            <tr>
                <td>关&nbsp;键&nbsp;字：
                #{select 'condition.searchKey', class:'input-small', value:condition.searchKey}
                    #{option ""}不限#{/option}
                    #{option "1"}商品名称#{/option}
                    #{option "2"}订单号#{/option}
                #{/select}

                    <input type="text" name="condition.searchItems" value="${condition.searchItems}"
                           class="input-medium"/></td>
                <td>订单状态：
                #{select 'condition.status', id:'condition_status', class:'input-small', value:condition.status}
                    #{option ""}不限#{/option}
                    #{option "UNPAID"}&{'order.UNPAID'}#{/option}
                    #{option "PAID"}&{'order.PAID'}#{/option}
                    #{option "CANCELED"}&{'order.CANCELED'}#{/option}
                    #{option "SENT"}&{'order.SENT'}#{/option}
                #{/select}
                    抽奖商品：<input type="checkbox" name="condition.isLottery" id="isLottery" class="input-medium"
                                value="${condition?.isLottery}" ${condition?.isLottery ?'checked':''}/>
                <td>
                    <button class="btn btn-primary" id="search" type="submit">搜索</button>
                    <button class="btn btn-primary" id="searchbtn" onclick="orderExcel()">导出报表</button>
                </td>
            </tr>
        </table>
    </form>
    <div style="color:#0082CA;"> 总计：${orderList.size()} 条记录</div>
#{vx.other_tab name:'order',enumItems: models.order.OrderStatus.values(),
select:'condition_status',value:condition?.status/}

    <table class="table table-striped table-bordered table-condensed">
        <thead>
        <tr>
            <th width="10">订单</th>
            <th width="50">商品名称</th>
            <th width="10">订单状态</th>
            <th width="15">帐号</th>
            <th width="10">订单来源</th>
            <th width="30">总金额</th>
            <th width="50">成交时间</th>
            <th width="50">退款时间</th>
            <th width="20">操 作</th>
        </tr>
        </thead>

        <tbody>
        #{paginate.list items:orderList, as:'order'}
        <tr>
            <td rowspan="${order.orderItems.size()}">${order.orderNumber}</td>
        *{有实物券时}*
            #{if order.realGoods.size()>0}
                <td>
                    #{if models.sales.MaterialType.ELECTRONIC.equals(order.realGoods.get(0).materialType)}
                        <img src="@@{'/public/images/electronic-goods.png'}">${order.realGoods.get(0).name}
                    #{/if}
                    #{else}
                        <img src="@@{'/public/images/real-goods.png'}">${order.realGoods.get(0).name}
                    #{/else}
                </td>
                <td rowspan="${order.realGoods.size()}">
                    #{if order.deliveryNo!=null}
                        <a id="sendInfo_${order.id}"
                           href="#" class="label label-info"
                           rel="popover"
                           data-content="运单号: ${order.deliveryNo}"
                           data-original-title="物流公司: ${order.deliveryCompany}"
                           onmouseover="$('#sendInfo_${order.id}').popover();">
                        &{'order.'+ order.realGoodsStatus}</a>
                    #{/if}
                    #{else}&{'order.'+order.realGoodsStatus}#{/else}
                    #{if models.order.OrderStatus.PAID.equals(order.realGoodsStatus)}
                        <br/><a href="#" id="linkSend_${order.id}" onclick="prepareSend(${order.id})">发货</a>
                    #{/if}
                </td>
            #{/if}

            #{else}
            *{有电子券时}*
                #{if order.electronicGoods.size()>0}
                    <td><img src="@@{'/public/images/electronic-goods.png'}">${order.electronicGoods.get(0).name}&nbsp;
                    </td>
                    <td rowspan="${order.electronicGoods.size()}">&{'order.'+order.electronicGoodsStatus}</td>
                #{/if}
                #{else}
                    <td>&nbsp;</td>
                    <td rowspan="${order.electronicGoods.size()}">&{'order.'+order.electronicGoodsStatus}</td>
                #{/else}
            #{/else}
            #{if order.userType ==models.accounts.AccountType.RESALER}
             <td rowspan="${order.orderItems.size()}">${order?.resaler?.loginName}</td>
            #{/if}
             #{if order.userType ==models.accounts.AccountType.CONSUMER}
              <td rowspan="${order.orderItems.size()}">${order?.user?.loginName}</td>
            #{/if}
            <td rowspan="${order.orderItems.size()}">&{'order.'+order.userType}</td>
            <td rowspan="${order.orderItems.size()}">${order.amount}</td>
            <td rowspan="${order.orderItems.size()}">${order.createdAt?.format("yyyy-MM-dd HH:mm:ss")}</td>
            <td rowspan="${order.orderItems.size()}">${order.refundAt?.format("yyyy-MM-dd HH:mm:ss")}</td>
            <td rowspan="${order.orderItems.size()}"><a href="@{OperateOrders.details(order.id)}">查看</a></td>
        </tr>
            #{set i:0/}
            #{set showRealStatus:true/}
            #{list items:order.realGoods, as:'aRealGoods'}
                #{if i>0}
                <tr test="i=${i}">
                    <td><img src="@@{'/public/images/real-goods.png'}">${aRealGoods.name}</td>
                *{#{if showRealStatus}}*
                *{<td rowspan="${order.realGoods.size()}">&{'order.'+}*
                *{order.realGoodsStatus}#{if models.order.OrderStatus.PAID.equals(order.status)}}*
                *{<br/><a href="#" id="linkSend">发货</a>#{/if}}*
                *{</td>}*
                *{#{set showRealStatus:false/}}*
                *{#{/if}}*

                </tr>
                #{/if}
                #{set i:i+1/}
            #{/list}

            #{set j:0/}
            #{set showElectronicStatus:true/}
            #{list items:order.electronicGoods, as:'aElectronicGoods'}
                #{if (order.realGoods.size()==0 && j>0) ||(order.realGoods.size()>0) }
                <tr>
                    <td><img src="@@{'/public/images/electronic-goods.png'}">${aElectronicGoods?.name}</td>
                    #{if showElectronicStatus && order.realGoods.size()>0}
                        <td rowspan="${order.electronicGoods.size()}">&{'order.'+order.electronicGoodsStatus}</td>
                        #{set showElectronicStatus:false/}
                    #{/if}
                </tr>
                #{/if}
                #{set j:j+1/}
            #{/list}

        #{/paginate.list}
        </tbody>
    </table>
    <div class="pagination" align="center">
        <ul>
        #{paginate.controls items:orderList /}
        </ul>
    </div>

</div>


<div class="modal" id="sendModal" style="display: none;">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>

        <h3>发货信息</h3>
    </div>
    <div class="modal-body">
    #{form @OperateOrders.index(), id:"sendForm", name:"sendForm", enctype:'multipart/form-data',
    class:"form-horizontal",method:"PUT"}
#{layout_operate.textField name:'order.deliveryCompany', value:order?.deliveryCompany, required:true,
    err:"deliveryCompany"/}
#{layout_operate.textField name:'order.deliveryNo', value:order?.deliveryNo, required:true/}
    #{/form}
    </div>
    <div class="modal-footer">
        <a href="#" id="send" class="btn btn-primary">发货</a>
        <a href="#" class="btn" data-dismiss="modal">取消</a>
    </div>
</div>


