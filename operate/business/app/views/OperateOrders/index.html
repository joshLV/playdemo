#{extends 'layout_operate/layout.html' /}
#{include 'share/nav.html' /}
#{set title:'商品订单' /}
#{set 'moreScripts'}
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
    function prepareSend(id) {
        $("#sendForm").attr("action", "/orders/" + id + "/send?x-http-method-override=PUT");
        $('#sendModal').modal('show');
    }

    $(function () {
        #{if !play.Play.mode.isDev()}
            $("#send").click(function () {
                var result = true;
                if ($("#order_deliveryNo").val().trim() == "") {
//                $("#note_order_deliveryNo").addClass("error");
                    $("#note_order_deliveryNo").html("请输入单号!");
                    $("#order_deliveryNo").focus();
                    result = false;
                }
                else {
//                $("#note_order_deliveryCompany").removeClass("error");
                    $("#note_order_deliveryCompany").html("");
                }
                if ($("#order_deliveryCompany").val().trim() == "") {
//                $("#note_order_deliveryCompany").addClass("error");
                    $("#note_order_deliveryCompany").html("请输入公司!");
                    $("#order_deliveryCompany").val("");
                    $("#order_deliveryCompany").focus();
                    result = false;
                } else {
                    $("#note_order_deliveryCompany").removeClass("error");
                    $("#note_order_deliveryCompany").html("");
                }
                if (result) {
                    $("#sendForm").submit();
                }
            });
        #{/if}
        #{else}
            $("#send").click(function () {
                $("#sendForm").submit();
            });
        #{/else}
    });
</script>
#{/set}
#{set 'moreStyles'}
<style type="text/css">
    .table td {
        vertical-align: middle;
    }
</style>
#{/set}
<div class="body">
    <legend>商品订单</legend>
    <form class="form-horizontal" name="frmlist" action="@{OperateOrders.index()}" method="GET">
        <table width="80%">
            <tr>
                <td>成交时间：<input type="text" id="createdAtBegin" name="condition.createdAtBegin"
                                value="${createdAtBegin?.format()}" onfocus="WdatePicker({readOnly:true})"
                                class="input-medium Wdate"/>至 <input type="text" id="createdAtEnd"
                                                                     name="condition.createdAtEnd"
                                                                     value="${createdAtEnd?.format()}"
                                                                     onfocus="WdatePicker({readOnly:true})"
                                                                     class="input-medium Wdate"/></td>
                <td>物流方式：
                #{select 'condition.deliveryType', class:'input-small', value:deliveryType}
                    #{option ""}不限#{/option}
                    #{option "1"}无物流#{/option}
                    #{option "2"}有物流#{/option}
                #{/select}
                </td>
            </tr>
            <tr>
                <td>退款时间：<input type="text" name="condition.refundAtBegin" value="${refundAtBegin?.format()}"
                                onfocus="WdatePicker({readOnly:true})"
                                class="input-medium Wdate"/>至 <input type="text" name="condition.refundAtEnd"
                                                                     value="${refundAtEnd?.format()}"
                                                                     onfocus="WdatePicker({readOnly:true})"
                                                                     class="input-medium Wdate"/></td>
                <td>支付方式：#{select 'condition.payMethod', class:'input-small', value:payMethod}
                    #{option ""}不限#{/option}
                    #{option "1"}支付宝#{/option}
                    #{option "2"}网银#{/option}
                #{/select}
                </td>
            </tr>
            <tr>
                <td>关&nbsp;键&nbsp;字：
                #{select 'condition.searchKey', class:'input-small', value:searchKey}
                    #{option ""}不限#{/option}
                    #{option "1"}商品名称#{/option}
                    #{option "2"}订单号#{/option}
                #{/select}

                    <input type="text" name="condition.searchItems" value="${searchItems}" class="input-medium"/></td>
                <td>订单状态：
                #{select 'condition.status', id:'condition_status', class:'input-small', value:status}
                    #{option ""}不限#{/option}
                    #{option "UNPAID"}&{'order.UNPAID'}#{/option}
                    #{option "PAID"}&{'order.PAID'}#{/option}
                    #{option "CANCELED"}&{'order.CANCELED'}#{/option}
                #{/select}

                <td>
                    <button class="btn btn-primary" id="searchbtn" type="submit">搜索</button>
                </td>
            </tr>
        </table>
    </form>
    <div style="margin-bottom: 12px">
        <button class="btn btn-primary" type="button">导出报表</button>
    </div>

    <table class="table table-striped table-bordered table-condensed">
        <thead>
        <tr>
            <th>订单</th>
            <th>商品名称</th>
            <th>订单状态</th>
            <th>订单来源</th>
            <th>总金额</th>
            <th>成交时间</th>
            <th>退款时间</th>
            <th>操 作</th>
        </tr>
        </thead>

        <tbody>
        #{paginate.list items:orderList, as:'order'}
        <tr>
            <td rowspan="${order.orderItems.size()}">${order.orderNumber}</td>
            #{if order.realGoods.size()>0}
                <td>#{if models.sales.MaterialType.ELECTRONIC.equals(order.realGoods.get(0).materialType)}<img
                        src="@@{'/public/images/electronic-goods.png'}"> #{/if}
                    #{else}<img src="@@{'/public/images/real-goods.png'}"> #{/else}${order.realGoods.get(0).name}</td>
                <td rowspan="${order.realGoods.size()}">#{if order.deliveryNo!=null}<a id="sendInfo_${order.id}"
                                                                                       href="#" class="label label-info"
                                                                                       rel="popover"
                                                                                       data-content="运单号: ${order.deliveryNo}"
                                                                                       data-original-title="物流公司: ${order.deliveryCompany}"
                                                                                       onmouseover="$('#sendInfo_${order.id}').popover();">&{'order.'+
                    order.realGoodsStatus}</a>
                #{/if}
                    #{else}&{'order.'+order.realGoodsStatus}#{/else}

                    #{if models.order.OrderStatus.PAID.equals(order.realGoodsStatus)}
                        <br/><a href="#" id="linkSend_${order.id}" onclick="prepareSend(${order.id})">发货</a>#{/if}
                </td>
            #{/if}

            #{else}
                #{if order.electronicGoods.size()>0}
                    <td><img src="@@{'/public/images/electronic-goods.png'}"> ${order.electronicGoods.get(0).name}</td>
                    <td rowspan="${order.electronicGoods.size()}">&{'order.'+order.electronicGoodsStatus}</td>
                #{/if}
            #{/else}
            <td rowspan="${order.orderItems.size()}">&{'order.'+order.userType}</td>
            <td rowspan="${order.orderItems.size()}">${order.amount}</td>

            <td rowspan="${order.orderItems.size()}">${order.createdAt?.format("yyyy-MM-dd HH:mm:ss")}</td>
            <td rowspan="${order.orderItems.size()}">${order.refundAt?.format("yyyy-MM-dd HH:mm:ss")}</td>
            <td rowspan="${order.orderItems.size()}"><a href="@{OperateOrders.details(order.id)}">查看</a></td>
        </tr>
            #{set i:0/}
            #{set showRealStatus:true/}
            #{list items:order.realGoods, as:'aRealGoods'}
                #{if i>0}
                <tr>
                    <td><img src="@@{'/public/images/real-goods.png'}"> ${aRealGoods.name}</td>
                    #{if showRealStatus}
                        <td rowspan="${order.realGoods.size()}">&{'order.'+
                            order.realGoodsStatus}#{if models.order.OrderStatus.PAID.equals(order.status)}
                                <br/><a href="#" id="linkSend">发货</a>#{/if}
                        </td>
                        #{set showRealStatus:false/}
                    #{/if}

                </tr>
                #{/if}
                #{set i:i+1/}
            #{/list}

            #{set j:0/}
            #{set showElectronicStatus:true/}
            #{list items:order.electronicGoods, as:'aElectronicGoods'}
                #{if (order.realGoods.size()==0 && j>0) ||(order.realGoods.size()>0) }
                <tr>
                    <td><img src="@@{'/public/images/electronic-goods.png'}"> ${aElectronicGoods.name}</td>
                    #{if showElectronicStatus}
                        <td rowspan="${order.electronicGoods.size()}">&{'order.'+order.electronicGoodsStatus}</td>
                        #{set showElectronicStatus:false/}
                    #{/if}
                </tr>
                #{/if}
                #{set j:j+1/}
            #{/list}

        #{/paginate.list}
        </tbody>
    </table>
    <div class="pagination" align="center">
        <ul>
        #{paginate.controls items:orderList /}
        </ul>
    </div>

</div>


<div class="modal" id="sendModal" style="display: none;">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>

        <h3>发货信息</h3>
    </div>
    <div class="modal-body">
    #{form @OperateOrders.index(), id:"sendForm", name:"sendForm", enctype:'multipart/form-data',
    class:"form-horizontal",method:"PUT"}
#{layout_operate.textField name:'order.deliveryCompany', value:order.deliveryCompany, required:true,
    err:"deliveryCompany"/}
#{layout_operate.textField name:'order.deliveryNo', value:order.deliveryNo, required:true/}
    #{/form}
    </div>
    <div class="modal-footer">
        <a href="#" id="send" class="btn btn-primary">发货</a>
        <a href="#" class="btn" data-dismiss="modal">取消</a>
    </div>
</div>


