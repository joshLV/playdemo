#{extends 'layout_trader/layout2.html' /}
#{include 'Share/nav.html' /}
#{set title:'新增预约' /}
#{set menu:"appointment_coupon_add" /}
#{set 'moreStyles'}
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
#{/set}
<div class="bd batch-verify">
    <h2>${title}</h2>

    <form id="coupon-form" action="@{SupplierAppointments.create()}">
        <div class="field-group">
            <label>门&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;店</label>
            <select name="shopId" value="${shopId}" id="shopId" style="width: auto">
            #{list items:shopList,as:'s'}
                <option value="${s.id}" ${shopId==s?.id ?'selected':''}/>${s.name}&nbsp;&nbsp;
            #{/list}
            </select>
        </div>

        <div class="field-group">
            <label class="coupon-label" for="enter-coupon">预约券号</label>
            <input type="text" size="18" maxlength="9" name="couponSn" id="couponSn" autofocus="true"
                   class="time" value="${couponSn}"/>
            <button class="btn add-coupon" type="button" id="searchCoupon">查询</button>
            <span id="coupon-error-info" style="color: red;margin-left: 10px;"></span>
            <span style="color: #c0c0c0;display: block">输入完券号请回车或点击【查询】</span>
        </div>
        <div id="coupon-info" style="display: none">
            <div class="field-group">
                <label class="coupon-label">预约日期</label>
                <input class="time" type="text" id="appointmentDate" name="appointmentDate"
                       value="${appointmentDate?.format('yyyy-MM-dd')}"
                       onfocus="WdatePicker({readOnly:true,minDate:'%y-%M-%d'})"/>
            </div>
            <div class="field-group">
                <label class="coupon-label" for="appointmentRemark">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注</label>
                <input type="text" style="width: 380px" maxlength="9" name="appointmentRemark" id="appointmentRemark"
                       class="time" value="${appointmentRemark}"/>
            </div>
            <div class="field-group">
                <button class="btn add-coupon" type="button" id="appointment">预约</button>
            </div>
        </div>
    </form>
</div>
#{set 'moreScripts'}
<script type="text/javascript">
    $(function () {
        $("#couponSn").blur(function () {
            verifyCoupon('');
        })
        $("#couponSn").keydown(function (e) {
            if (e.keyCode == 13) {
                verifyCoupon('');
                return false;
            }
        });
        $("#searchCoupon").click(function () {
            verifyCoupon('');
        })
        $("#appointment").click(function () {
            verifyCoupon("appointment");
        })
    })
    function verifyCoupon(val) {
        var couponSn = $("#couponSn").val();
        if (couponSn == "") {
            $("#coupon-info").hide();
            return;
        }
        var shopId = $("#shopId").val();
        var url = "/coupon-appointment/verify";
        var params = "shopId=" + shopId + "&couponSn=" + couponSn;
        if (val == "appointment") {
            params += "&appointmentDate=" + $("#appointmentDate").val() + "&appointmentRemark=" + $("#appointmentRemark").val();
            url = "/coupon-appointment";
        }
        $("#coupon-error-info").text("")

        $.ajax({
            url: url,
            type: "post",
            data: params,
            success: function (data) {
                // 券号不能通过验证时，给出提示
                if (data.errorInfo != null && data.errorInfo != "null") {
                    $("#coupon-error-info").text(data.errorInfo);
                    $("#coupon-info").hide();
                    return;
                }
                if (val == '') {
                    $("#coupon-info").show();
                    return;
                }
                if (val == "appointment") {
                    $("#coupon-form").submit();
                }

            }, error: function () {
                alert("请求失败！");
                $("#coupon-info").hide();
                return;
            }

        });
    }
</script>
#{/set}