#{extends 'layout_trader/layout2.html' /}
#{set title:'价格策略' /}
#{set menu:"ktv_price" /}
#{set 'moreStyles'}
<style type="text/css">
    .hour {
        width: 40px;
        line-height: 30px;
        background-color: #eaf6fd;
        border: 1px solid #b4d3eb;
        position: absolute;
        font-size: 12px;
        text-align: center;
        font-weight: normal;
        cursor: pointer;
        overflow: hidden;
        white-space: nowrap;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .hour-selected {
        background-color: #1ABC9C;
        color: #fff;
    }

    #roomCountTable tr {
        height: 35px;
    }
    .field-group label {
        font-weight:normal;
    }
    .sidebar {
        display:none
    }
    .section {
        float:none;
        width:auto;
    }
    #message{
        display:none;
    }
    .field-group {
        padding-left:180px;
    }
    .field-group label {
        width:150px;
    }
    .switch_time_range{
        padding:10px;
        border: 1px solid #eee;
        cursor:pointer;
        float:left;
    }
    .preview_box {
        border:1px dotted #eee;
        width:500px;
        padding:10px 20px;
        color: #888;
        font-size: 12px;
     }
    .delDay {
        border: 1px solid #eee;
        padding:0 5px;
        cursor:pointer;
        margin-left:5px;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    .alert_error {
        background-color: #f2dede;
        color: #b94a48;
        padding: 8px 14px;
    }
    .alert_error a,
    .alert_error strong {
        color: #4875b9;
    }
</style>
#{/set}
<div class="body">
#{form @KtvPriceSchedules.create() , id:'creationForm',class:"form-horizontal" }
    <div class="bd">
        <h2>${title}</h2>

        <div class="field-group">
            <label>可预订日期</label>
            <input type="text" class="time" id="startDay"  onfocus="WdatePicker({readOnly:true})"
                   value="${new java.util.Date().format()}">
            <span>到</span>
            <input type="text" class="time" id="endDay"  onfocus="WdatePicker({readOnly:true})" value="">(包括)
            <span class="btn" id="addDate"> 添加</span>
        </div>
        <div class="field-group">
            <div class="preview_box" id="dayPreview">
                未添加，请选择日期范围，并点击添加
            </div>
            <input type="hidden" name="days" id="inputDays">
        </div>

        <div class="field-group">
            <label>套餐产品</label>
            <select name="priceStrategy.product.id" id="priceStrategy_product_id" style="width: auto">
                #{list ktvProductList,as :'product'}
                    <option value="${product.id}" data-duration="${product.duration}">${product.name}</option>
                #{/list}
            </select>
        </div>

        <div class="field-group">
            <label>可预订时段</label>
            <div>
                <div class="switch_time_range" data-offset="0">&lt;</div>
                <div style="width:600px; overflow:hidden; position:relative;border:6px solid #eee; padding:4px;float:left;margin-left:5px;">
                    <div style="position:relative; height:30px;left:0;" id="timeRangeBox">
                        #{list items:0..23, as:'hour'}
                        %{ hourStr = hour < 10 ? "0" + hour : "" + hour; }%
                        <div class="hour" style="z-index:${50-hour};left:${hour*44}px" data-hour="${hourStr}:00">${hourStr}:00</div>
                        #{/list}
                    </div>
                </div>
                <div class="switch_time_range" style="margin-left:5px;" data-offset="-460px">&gt;</div>
            </div>
            <div style="clear:both"></div>
        </div>
        <div class="field-group">
            <div class="preview_box" id="hourPreview">
                未选择时间段，请在上部并点击添加
            </div>
        </div>
        <input type="hidden" name="priceStrategy.startTimes" id="inputStartTimes">

        <div class="field-group">
            <label>适用包厢</label>
            #{list items:models.ktv.KtvRoomType.values(), as:'roomType'}
                <input type="radio" name="priceStrategy.roomType" value="${roomType}"/>${roomType.name} &nbsp;&nbsp;
            #{/list}
        </div>

        <div class="field-group">
            <label>包厢价格</label>
            <input type="text" id="price" name="priceStrategy.price"/> 元 / 每 <span id="durationPer"></span> 小时
        </div>


        <div class="field-group">
            <label>选择适用门店</label>
            #{list items:shops,as:'shop'}
                <input type="checkbox" class="shops" data-shop-id="${shop.id}" data-name="${shop.name}"/>${shop.name}
                &nbsp;&nbsp;
            #{/list}
        </div>

        <div class="field-group">
            <label>每时段包厢数量</label>
            <table cellpadding="0" cellspacing="0" id="roomCountTable">
                <tr>
                    <td>统一设置 &nbsp;&nbsp;</td>
                    <td><input type="text" size="3" id="roomCountAll"/>个</td>
                </tr>
                <tr style="height:20px;">
                    <td colspan="2"></td>
                </tr>
            </table>
        </div>
        <div class="field-group" >
            <div class="alert_error" id="errorMsg" style="display: none">
            </div>
        </div>
        <div class="field-group">
            <input type="button" class="btn" value="创建" id="createButton"/>
        </div>

    </div>
#{/form}
</div>
#{set 'moreScripts'}
<script src="@{'/public/javascripts/My97DatePicker/WdatePicker.js'}" type="text/javascript" charset="UTF-8"></script>
<script type="text/javascript">
    var selectedHours = [];
    var selectedDays =[];
    //刷新显示 已选择的日期
    function resetDayInput(){
        var days = [];
        $.each(selectedDays, function(index, entry){
            days.push(dateToHan(entry[0])+"-"+dateToHan(entry[1]));
        });
        $("#inputDays").val(days.join(";"));
    }
    function resetHourInput() {
        selectedHours.sort(function(a,b){return a-b})
        $("#inputStartTimes").val(selectedHours.join(","));
        var hourPreview = $("#hourPreview");
        var eleSelectedDuration = $("#priceStrategy_product_id option:selected");
        var duration = Number(eleSelectedDuration.attr("data-duration"));
        if(selectedHours.length == 0){
            hourPreview.text("未选择时间段，请在上部并点击添加");
        }else{
            hourPreview.empty();
            $.each(selectedHours, function(index, hour){
                hourPreview.append(
                        $("<span>",{text: fill2(hour) + ":00 - " + fill2(hour+duration) + ":00 | "})
                );
                if(((index + 1)%4) == 0){
                    hourPreview.append($("<br>"));
                }
            });
        }
    }
    //重设已选择的时间
    function resetSelectedHours() {
        selectedHours = [];
        $(".hour").each(function () {
            var ele = $(this);
            ele.removeClass("hour-selected");
            ele.removeClass("hour-selected");
            ele.text(ele.attr("data-hour"));
            ele.animate({width: "40px"}, 100);
        });
        resetHourInput();
    }
    function fill2(n){
        if (n < 10) return "0" + n;
        return "" + n;
    }
    function dateToHan(date) {
        return date.getFullYear()+"年" + fill2(date.getMonth()+1) + "月" + fill2(date.getDate()) + "日";
    }
    //点击删除已选日期
    function delDayClick() {
        var ele = $(this);
        var startTime = new Date(ele.attr("data-start")).getTime();
        var endTime = new Date(ele.attr("data-end")).getTime();
        var index = -1;
        for(var i = 0 ; i < selectedDays.length; i ++){
            var entry = selectedDays[i];
            if(startTime == entry[0].getTime() && endTime == entry[1].getTime()){
                index = i;
                break;
            }
        }
        if (index >=0 ) {
            selectedDays.splice(index, 1);
            ele.unbind("click");
            ele.parent().remove();
            if(selectedDays.length==0) {
                $("#dayPreview").text("未添加，请选择日期范围，并点击添加");
            }
            resetDayInput();
        }
    }
    $(function () {
        $("#durationPer").text($("#priceStrategy_product_id option:selected").attr("data-duration"));
        //选择门店
        $("input[data-shop-id]").change(function () {
            var roomCountAll = $("#roomCountAll").val();
            var ele = $(this);
            if (ele.is(":checked")) {
                $("#roomCountTable").append(
                        $("<tr/>").attr("row-shop-id", ele.attr("data-shop-id")).append(
                                        $("<td/>").text(ele.attr("data-name"))
                                ).append(
                                        $("<td/>").append(
                                                $("<input/>", {
                                                    type: "text",
                                                    name: "shop-" + ele.attr("data-shop-id"),
                                                    size: "3",
                                                    "data-shop-name": ele.attr("data-name"),
                                                    "data-shop-id": ele.attr("data-shop-id"),
                                                    value: roomCountAll})
                                        ).append($("<span/>").text("个"))
                                )
                )
            } else {
                $("#roomCountTable tr[row-shop-id='" + $(this).attr("data-shop-id") + "']").remove();
            }
        });
        //左右移动时间范围
        $(".switch_time_range").click(function(){
            $("#timeRangeBox").animate({left: $(this).attr("data-offset")},100);
        });
        var startDayEle = $("#startDay");
        var endDayEle = $("#endDay");
        var dayPreview = $("#dayPreview");
        //点击添加日期
        $("#addDate").click(function(){
            var startDayVal = startDayEle.val()
            var endDayVal = endDayEle.val()
            if(!startDayVal || !endDayVal){
                alert("请选择日期");return;
            }
            startDay = new Date(startDayVal);
            endDay = new Date(endDayVal);
            if(startDay.getTime() > endDay.getTime()){
                alert("结束日期不可小于开始日期");return;
            }
            var today = new Date();
            today = new Date(today.getFullYear() + "-" + today.getMonth() + "-" + today.getDate());
            if(endDay < today) {
                alert("结束日期必须大于等于今天");return;
            }
            //检查冲突
            var startDayTime = startDay.getTime();
            var endDayTime = endDay.getTime();

            var conflict = false;
            $.each(selectedDays, function(index, entry){
                if (startDayTime <= entry[1].getTime() && endDayTime >=entry[0].getTime()){
                    conflict = true;
                    alert("与 " + dateToHan(entry[0]) + " - " + dateToHan(entry[1]) + " 日期范围重合，请重新选择");
                    conflict = true;
                    return false;
                }
            } );
            if(conflict) {
                return;
            }

            if(selectedDays.length == 0){
                dayPreview.empty();
            }
            var text = dateToHan(startDay) + " - " + dateToHan(endDay);
            dayPreview.append(
                $("<div>", {style:"margin-bottom:4px;"})
                    .append( $("<span>",{text: text}))
                    .append($("<span>",{text:"x", class:"delDay", "data-start":startDayVal,"data-end":endDayVal, click:delDayClick}))
            );
            selectedDays.push([startDay, endDay]);
            var newStartDay = new Date(endDay);
            newStartDay.setDate(endDay.getDate() + 1);
            startDayEle.val(newStartDay.getFullYear() + "-" + (newStartDay.getMonth()+1) + "-" + newStartDay.getDate());
            endDayEle.val(startDayEle.val());
            resetDayInput();
        });
        //设置统一的门店数量
        $("#roomCountAll").keyup(function () {
            $("#roomCountTable input[data-shop-id]").val($(this).val());
        });
        //切换时长radio
        $("#priceStrategy_product_id").change(function () {
            var ele = $("#priceStrategy_product_id option:selected");
            $("#durationPer").text(ele.attr("data-duration"));
            resetSelectedHours();
        });
        //点击时间点
        $(".hour").click(function () {
            var ele = $(this);
            var hour = Number(ele.attr("data-hour").substring(0, 2));

            var index = $.inArray(hour, selectedHours);
            if (index >= 0) {
                selectedHours.splice(index, 1);
                ele.removeClass("hour-selected");
                ele.text(ele.attr("data-hour"));
                ele.animate({width: "36px"}, 100);
            } else {
                var eleSelectedDuration = $("#priceStrategy_product_id option:selected");
                var duration = Number(eleSelectedDuration.attr("data-duration"));
                if (hour + duration > 24) {
                    return;
                }
                for (var i = 1; i < duration; i++) {
                    var j = $.inArray(hour + i, selectedHours);
                    if (j >= 0) {
                        return;
                    }
                }
                selectedHours.push(hour);
                ele.addClass("hour-selected");
                start = hour < 10 ? "0" + hour : hour;
                end = hour+duration;
                end = end < 10 ? "0" + end : end;
                ele.text(start + ":00 - " + end + ":00");
                ele.animate({width: (duration * 44 - 4) + "px"}, 80);
            }
            resetHourInput();
        });
        $("#createButton").click(function () {
            var errorEle = $("#errorMsg");
            errorEle.hide();
            var inputDays = $("#inputDays").val();
            if (!inputDays) {
                errorEle.text("请选择预订日期范围，并点击添加").show();
                return;
            }
            var roomType = $("input[name='priceStrategy.roomType']:checked").val();
            if (!roomType) {
                errorEle.text("请选择包厢类型").show();
                return;
            }
            var price = $("#price").val();
            if (!price) {
                errorEle.text("请填写价格").show();
                return;
            }
            var inputStartTimes = $("#inputStartTimes").val();
            if (!inputStartTimes) {
                errorEle.text("请选择预订时段").show();
                return;
            }
            var shopInputs = $(".shops:checked");
            if (shopInputs.length == 0) {
                errorEle.text("请选择适用门店").show();
                return;
            }
            var allRoomCountSet = true;
            $("input[name^='shop-']").each(function () {
                var ele = $(this);
                if (!ele.val()) {
                    allRoomCountSet = false;
                    errorEle.text("请设置 [" + ele.attr("data-shop-name") + "] 的包厢数量").show();
                    return false;
                }
            });
            if (!allRoomCountSet) {
                return
            }
            var shopIds = [];
            shopInputs.each(function () {
                shopIds.push($(this).attr("data-shop-id"));
            });

            //检查是否有冲突
            $.ajax({
                type:'POST',
                url:'/ktv/price-schedule/collision-detect',
                data:{
                    "priceStrategy.product.id": $("#priceStrategy_product_id").val(),
                    "priceStrategy.roomType": roomType,
                    "days":inputDays,
                    "shopIds": shopIds.join(","),
                    "startTimes": inputStartTimes
                },
                success:function (data) {
                    if (!data.isOk) {
                        if (data.error) {
                            errorEle.text(data.error).show();
                        } else if (data.scheduleId) {
                            errorEle.empty()
                                    .append($("<span>", {text:"与已有的价格策略冲突，"}))
                                    .append($("<a>", {target:"_blank", text:"点击查看", href:"#"}))
                                    .append($("<span>", {text:"发生冲突的价格策略"})).show();
                        }
                    }else{
                        $("#creationForm").submit();
                    }
                },
                error:function(data) {
                    errorEle.text("服务器发生错误").show();
                }
            });
        });
    });
</script>
#{/set}
